{% extends "base.html" %}

{% block title %}Email Manager - Task Scheduler{% endblock %}

{% block content %}
<div class="mb-4">
    <h1><i class="fas fa-envelope"></i> Email Manager</h1>
    <p class="text-muted">Configure email settings and schedule email tasks</p>
</div>

<!-- Email Configuration Card -->
<div class="card mb-4">
    <div class="card-header bg-primary text-white">
        <h5 class="mb-0"><i class="fas fa-cog"></i> Email Configuration</h5>
    </div>
    <div class="card-body">
        <div id="config-status"></div>
        
        <form id="emailConfigForm" class="mt-3">
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="email" class="form-label">
                        <i class="fas fa-envelope"></i> Email Address *
                    </label>
                    <input type="email" class="form-control" id="email" name="email" required
                           placeholder="your.email@gmail.com">
                </div>
                <div class="col-md-6 mb-3">
                    <label for="password" class="form-label">
                        <i class="fas fa-key"></i> App Password *
                    </label>
                    <input type="password" class="form-control" id="password" name="password" required
                           placeholder="Enter Gmail App Password">
                    <small class="form-text text-muted">
                        <a href="https://support.google.com/accounts/answer/185833" target="_blank">
                            How to get Gmail App Password?
                        </a>
                    </small>
                </div>
            </div>
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="smtp_server" class="form-label">SMTP Server</label>
                    <input type="text" class="form-control" id="smtp_server" name="smtp_server" 
                           value="smtp.gmail.com">
                </div>
                <div class="col-md-6 mb-3">
                    <label for="smtp_port" class="form-label">SMTP Port</label>
                    <input type="number" class="form-control" id="smtp_port" name="smtp_port" 
                           value="587">
                </div>
            </div>
            <button type="submit" class="btn btn-primary">
                <i class="fas fa-save"></i> Save Configuration
            </button>
            <button type="button" class="btn btn-secondary" onclick="testEmail()">
                <i class="fas fa-paper-plane"></i> Send Test Email
            </button>
        </form>
    </div>
</div>

<!-- Quick Email Actions -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card h-100">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0"><i class="fas fa-heartbeat"></i> System Health Check Email</h5>
            </div>
            <div class="card-body">
                <p>Send system health check report via email</p>
                <form id="healthEmailForm">
                    <div class="mb-3">
                        <label for="health_recipient" class="form-label">Recipient Email</label>
                        <input type="email" class="form-control" id="health_recipient" required
                               placeholder="recipient@example.com">
                    </div>
                    <div class="mb-3">
                        <label for="health_schedule" class="form-label">Schedule</label>
                        <select class="form-select" id="health_schedule">
                            <option value="">Send Now (No Schedule)</option>
                            <option value="* * * * *">Every 1 minute</option>
                            <option value="*/5 * * * *">Every 5 minutes</option>
                            <option value="*/10 * * * *">Every 10 minutes</option>
                            <option value="*/30 * * * *">Every 30 minutes</option>
                            <option value="0 * * * *">Every 1 hour</option>
                            <option value="0 */3 * * *">Every 3 hours</option>
                            <option value="0 */6 * * *">Every 6 hours</option>
                            <option value="0 9 * * *">Daily at 9 AM</option>
                            <option value="0 9 * * 1">Weekly (Monday 9 AM)</option>
                        </select>
                    </div>
                    <button type="submit" class="btn btn-success w-100">
                        <i class="fas fa-paper-plane"></i> Send/Schedule Health Check
                    </button>
                </form>
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card h-100">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0"><i class="fas fa-edit"></i> Custom Email</h5>
            </div>
            <div class="card-body">
                <p>Send custom email message</p>
                <form id="customEmailForm">
                    <div class="mb-3">
                        <label for="custom_recipient" class="form-label">Recipient Email</label>
                        <input type="email" class="form-control" id="custom_recipient" required
                               placeholder="recipient@example.com">
                    </div>
                    <div class="mb-3">
                        <label for="custom_subject" class="form-label">Subject</label>
                        <input type="text" class="form-control" id="custom_subject" required
                               placeholder="Email subject">
                    </div>
                    <div class="mb-3">
                        <label for="custom_message" class="form-label">Message</label>
                        <textarea class="form-control" id="custom_message" rows="3" required
                                  placeholder="Your message here"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="custom_schedule" class="form-label">Schedule</label>
                        <select class="form-select" id="custom_schedule">
                            <option value="">Send Now (No Schedule)</option>
                            <option value="* * * * *">Every 1 minute</option>
                            <option value="*/5 * * * *">Every 5 minutes</option>
                            <option value="*/10 * * * *">Every 10 minutes</option>
                            <option value="*/30 * * * *">Every 30 minutes</option>
                            <option value="0 * * * *">Every 1 hour</option>
                            <option value="0 */3 * * *">Every 3 hours</option>
                            <option value="0 9 * * *">Daily at 9 AM</option>
                        </select>
                    </div>
                    <button type="submit" class="btn btn-info w-100">
                        <i class="fas fa-paper-plane"></i> Send/Schedule Custom Email
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Scheduled Email Tasks -->
<div class="card">
    <div class="card-header">
        <h5 class="mb-0"><i class="fas fa-list"></i> Scheduled Email Tasks</h5>
    </div>
    <div class="card-body">
        <div id="email-tasks-list">
            <div class="text-center py-3">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
// Check email configuration status
function checkEmailConfig() {
    fetch('/api/email/config')
        .then(response => response.json())
        .then(data => {
            const statusDiv = document.getElementById('config-status');
            if (data.configured) {
                statusDiv.innerHTML = `
                    <div class="alert alert-success">
                        <i class="fas fa-check-circle"></i> Email configured: ${data.email}
                    </div>
                `;
                document.getElementById('email').value = data.email;
            } else {
                statusDiv.innerHTML = `
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle"></i> Email not configured. Please enter your credentials below.
                    </div>
                `;
            }
        });
}

// Save email configuration
document.getElementById('emailConfigForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = {
        email: document.getElementById('email').value,
        password: document.getElementById('password').value,
        smtp_server: document.getElementById('smtp_server').value,
        smtp_port: parseInt(document.getElementById('smtp_port').value)
    };
    
    fetch('/api/email/config', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(formData)
    })
    .then(response => response.json())
    .then(data => {
        alert('✅ Email configuration saved successfully!');
        checkEmailConfig();
    })
    .catch(error => {
        alert('❌ Failed to save configuration: ' + error);
    });
});

// Send test email
function testEmail() {
    const email = document.getElementById('email').value;
    if (!email) {
        alert('Please enter an email address first');
        return;
    }
    
    fetch('/api/email/test', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({recipient: email})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('✅ Test email sent successfully! Check your inbox.');
        } else {
            alert('❌ Failed to send test email: ' + data.message);
        }
    })
    .catch(error => {
        alert('❌ Error: ' + error);
    });
}

// Send/Schedule health check email
document.getElementById('healthEmailForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const recipient = document.getElementById('health_recipient').value;
    const schedule = document.getElementById('health_schedule').value;
    
    if (schedule) {
        // Create scheduled task
        const taskData = {
            task_name: `Health Check Email to ${recipient}`,
            command: `python email_system.py health ${recipient}`,
            schedule: schedule,
            description: `Scheduled system health check email to ${recipient}`
        };
        
        fetch('/tasks', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(taskData)
        })
        .then(response => response.json())
        .then(data => {
            alert('✅ Health check email scheduled successfully!');
            loadEmailTasks();
        })
        .catch(error => {
            alert('❌ Failed to schedule: ' + error);
        });
    } else {
        // Send immediately
        fetch('/api/email/send-health', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({recipient: recipient})
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('✅ Health check email sent successfully!');
            } else {
                alert('❌ Failed to send: ' + data.message);
            }
        })
        .catch(error => {
            alert('❌ Error: ' + error);
        });
    }
});

// Send/Schedule custom email
document.getElementById('customEmailForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const recipient = document.getElementById('custom_recipient').value;
    const subject = document.getElementById('custom_subject').value;
    const message = document.getElementById('custom_message').value;
    const schedule = document.getElementById('custom_schedule').value;
    
    if (schedule) {
        // Create scheduled task
        const taskData = {
            task_name: `Custom Email: ${subject}`,
            command: `python email_system.py custom "${recipient}" "${subject}" "${message}"`,
            schedule: schedule,
            description: `Scheduled custom email to ${recipient}`
        };
        
        fetch('/tasks', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(taskData)
        })
        .then(response => response.json())
        .then(data => {
            alert('✅ Custom email scheduled successfully!');
            loadEmailTasks();
        })
        .catch(error => {
            alert('❌ Failed to schedule: ' + error);
        });
    } else {
        // Send immediately
        fetch('/api/email/send-custom', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                recipient: recipient,
                subject: subject,
                message: message
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('✅ Custom email sent successfully!');
            } else {
                alert('❌ Failed to send: ' + data.message);
            }
        })
        .catch(error => {
            alert('❌ Error: ' + error);
        });
    }
});

// Load email tasks
function loadEmailTasks() {
    fetch('/tasks')
        .then(response => response.json())
        .then(tasks => {
            const emailTasks = tasks.filter(t => 
                t.command.includes('email_system.py') || 
                t.command.includes('email_sender.py')
            );
            
            const listDiv = document.getElementById('email-tasks-list');
            
            if (emailTasks.length === 0) {
                listDiv.innerHTML = '<p class="text-muted text-center">No scheduled email tasks</p>';
                return;
            }
            
            let html = '<div class="table-responsive"><table class="table table-hover"><thead><tr><th>Task Name</th><th>Schedule</th><th>Status</th><th>Next Run</th><th>Actions</th></tr></thead><tbody>';
            
            emailTasks.forEach(task => {
                const statusBadge = task.status === 'active' ? 
                    '<span class="badge bg-success">Active</span>' : 
                    '<span class="badge bg-secondary">Inactive</span>';
                
                const toggleButton = task.status === 'active' ?
                    `<button class="btn btn-sm btn-warning" onclick="toggleTask(${task.id}, 'pause')" title="Pause Task">
                        <i class="fas fa-pause"></i>
                    </button>` :
                    `<button class="btn btn-sm btn-success" onclick="toggleTask(${task.id}, 'resume')" title="Resume Task">
                        <i class="fas fa-play"></i>
                    </button>`;
                
                html += `
                    <tr>
                        <td>${task.task_name}</td>
                        <td><code>${task.schedule}</code></td>
                        <td>${statusBadge}</td>
                        <td>${task.next_run || 'N/A'}</td>
                        <td>
                            <a href="/tasks/${task.id}/view" class="btn btn-sm btn-primary" title="View Details">
                                <i class="fas fa-eye"></i>
                            </a>
                            ${toggleButton}
                            <button class="btn btn-sm btn-danger" onclick="deleteTask(${task.id})" title="Delete Task">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            html += '</tbody></table></div>';
            listDiv.innerHTML = html;
        });
}

// Toggle task (pause/resume)
function toggleTask(taskId, action) {
    const confirmMsg = action === 'pause' ? 
        'Are you sure you want to pause this email task?' : 
        'Are you sure you want to resume this email task?';
    
    if (!confirm(confirmMsg)) return;
    
    fetch(`/tasks/${taskId}/toggle`, {
        method: 'POST'
    })
    .then(response => {
        if (response.ok) {
            alert(`✅ Task ${action === 'pause' ? 'paused' : 'resumed'} successfully!`);
            loadEmailTasks();
        } else {
            alert('❌ Failed to update task');
        }
    })
    .catch(error => {
        alert('❌ Error: ' + error);
    });
}

// Delete task
function deleteTask(taskId) {
    if (!confirm('Are you sure you want to delete this email task? This cannot be undone.')) {
        return;
    }
    
    fetch(`/tasks/${taskId}/delete`, {
        method: 'POST'
    })
    .then(response => {
        if (response.ok) {
            alert('✅ Task deleted successfully!');
            loadEmailTasks();
        } else {
            alert('❌ Failed to delete task');
        }
    })
    .catch(error => {
        alert('❌ Error: ' + error);
    });
}

// Initialize
checkEmailConfig();
loadEmailTasks();
</script>
{% endblock %}
